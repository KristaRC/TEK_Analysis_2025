---
title: "Final_TEK_Analysis"
author: "Krista Romero-Cardenas"
date: "2025-11-27"
output:
  pdf_document: default
  html_document: default
---

```{r}
#install.packages("viridis")
#install.packages("rlang")

#tinytex::install_tinytex()
library(knitr)
library(gt)
library(dplyr)
library(viridis) 
library(readr)
library(tidyverse)
```
#check working directory:
```{r}
#getwd()
#setwd("/Users/kristalina/Documents/TEK Analysis Practice")
```

#will need to use full original data set due to coding style. (fe: a citation reference is showing in "section question", but if we remove that column, the info traceability does now work) 
```{r}
ods_tek <- read_csv("2025NEPATEKStudy_DATA_10.8.2025.csv")
#View(ods_tek)
```
 
```{r}
##get frequencies by AGENCY for completed EISs, & Remove 'NA's

Record_ID_completed<- ods_tek %>% 
 filter(tek_eis_description_complete==2) %>%
 select(record_id, agency) |> 
   drop_na()
Record_ID_completed

Everything_for_completed_EIS<- ods_tek %>%
  filter(record_id %in% Record_ID_completed$record_id)

Freq_Agency <- Everything_for_completed_EIS %>%
  drop_na(agency) %>%
 count(agency,sort=TRUE)
Freq_Agency

```

```{r}
#exported table of 
#FREQUENCY OF TEK TERMS PER AGENCY
write_csv(Freq_Agency, file="FEISs by Agency_10.2025.csv")
```

#using the Redcap 708 FEIS sample population, we are pulling the # of FEISs per agency
```{r}
Agency_Freq_of_708 <- ods_tek  |> 
  drop_na(agency) |> 
  count(agency,sort=TRUE)
Agency_Freq_of_708
# tibble: 47 x 2
# Includes sum of 47 agency FEIS/records 
# (708 agency SS sum)
```
#Now we need to load in the NEPAccess database file with ~4k FEIS 

```{r}
library(readxl)
#Load Egoitz(NLP) full FEIS population size  (3,945 popultation)

Egoitz_EIS_list <- read_excel("AGENCY_NEPAccess_Final.xlsx", skip=1)

Egoitz_EIS_list <- Egoitz_EIS_list %>% 
    rename(
          Agency = `Agriculture Research Service`,
          W.Records = '2...2',
           W.Documents = '2...3',
           W.O.Records = '2...4',
           W.O.Documents = '2...5'
           )
#View(Egoitz_EIS_list)
# tibble: 94 x 5
#Includes the “Agency” & 4 columns of records
# There are a total of 94 agencies that have an EIS in NEPAccess
```



```{r}
#here we are using the 47 agencies in the 708 sample size "Agency_Freq_of_708" and adding in (left join) of Egoitz NEPAccess database records.

agency.prop.4k_708<- 
  left_join(Agency_Freq_of_708, Egoitz_EIS_list, by = join_by(agency==Agency))

agency.prop.4k_708<- agency.prop.4k_708 %>%  #col(n)=708 sample size; col(W.O.Docs)=3,943
  select(agency,n,W.O.Documents) %>% 
mutate(agency_prop_708 = round(n / W.O.Documents,3)) %>% 
rename(Sample_of_Population=n, Population= W.O.Documents, Agency_Population_Ratio = agency_prop_708) %>% 
   relocate(Population, .before=Sample_of_Population)

agency.prop.4k_708
```

#now I want to add another column into agency.prop.45_708 to include the 250 sample size

```{r}
SS_4k_708_247 <- left_join(
  Freq_Agency, agency.prop.4k_708, 
  by = join_by(agency==agency)) %>%
  rename(
    `Study Sample Size` = n,
    `NEPAccess Repository Sample` = Population,
    `708 TEK Sample Size` = Sample_of_Population
  ) |> 
  select(
    agency,
    `NEPAccess Repository Sample`,
    `708 TEK Sample Size`,
    `Study Sample Size`
  )

```

#Calculate ratio of population sample (~4k) to TEK sample size (708); and 708 sample size with 247 FEIS sample size
```{r}
SS_4k_708_247 <- SS_4k_708_247 %>%
  #Calculate ratio from ~4k data repository sample to 708 sample 
  mutate(
    `Repository_to_TEK_Ratio` = round(`708 TEK Sample Size` / `NEPAccess Repository Sample`, 3),
#Now, Calculate ratio from 708 sample with 247 investigated sample size
    `708_TEK_Ratio_to_247_ss` = round(`Study Sample Size` / `708 TEK Sample Size`, 3)
  ) %>%
  #below I am putting the ratio columns in the appropriate order
  relocate(`Repository_to_TEK_Ratio`, .after = `NEPAccess Repository Sample`) %>%
  relocate(`708_TEK_Ratio_to_247_ss`, .after = `708 TEK Sample Size`)
SS_4k_708_247
```


```{r}
print(SS_4k_708_247, n = Inf)

```

```{r}
colnames(SS_4k_708_247)
```


```{r}
#renaming the column names to prep for table export
library(dplyr)

# SS_4k_708_247_clean <- SS_4k_708_247 %>%
#   rename(
#     Agency = agency,
#     `NEPAccess Repository Sample` = NEPAaccess Repository Sample,
#     `Repository to TEK Ratio` = Repository_to_TEK_Ratio,
#     `708 TEK Sample Size` = 708 TEK Sample Size,
#     `TEK Ratio to Study Sample` = `708_TEK_Ratio_to_247_ss`,
#     `Study Sample Size` = Study Sample Size
#   )

SS_4k_708_247_clean <- SS_4k_708_247 %>%
  rename(
    Agency = agency,
  #  `NEPAccess Repository Sample` = `NEPAccess Repository Sample`,
    `Repository to TEK Ratio` = Repository_to_TEK_Ratio,
  #  `708 TEK Sample Size` = `708 TEK Sample Size`,
    `708 TEK Ratio to Study Sample` = `708_TEK_Ratio_to_247_ss`,
    `Study Sample Size` = `Study Sample Size`
  )

```


```{r}
library(gt)

table_export <- SS_4k_708_247_clean %>%
  gt() %>%
  tab_header(
    title = "Agency Representation in NEPA and TEK Samples",
    subtitle = "Comparison of repository, TEK, and study sample sizes"
  )

# View nicely in RStudio
table_export

# Save to file
#gtsave(table_export, "/Users/kristalina/Documents/TEK Analysis Practice/Agency_SampleRatio_Table.PNG")

```

###PIVOT

#clean up data - removing false positives for "Categories of TEK use"
```{r}
# remove false positives
TEK_mentions_ss<- Everything_for_completed_EIS%>% 
  filter(procedural_use!=3 & procedural_use!=8 & procedural_use!=10 & procedural_use!=14 & procedural_use!=16 & redcap_repeat_instrument=="tek_repeats") 
#!= means does not equal
#we are removing false positive and unclear, keeping repeat mentions
 nrow(TEK_mentions_ss)

```
#remember that you kept the illegible in because not all records/FEIS were marked


#Total TEK terms and their frequencies, (including those with 0 mentions)
```{r}
#	TEK Term used --> [tek_term_used, question #25], 1-18, 

tek_term<- read_csv("tek_term_code.csv")
colnames(tek_term)

total_tek_term_count <- left_join(TEK_mentions_ss, tek_term, by = c("tek_term_used" = "code"))

total_tek_term_count <- total_tek_term_count %>%
 drop_na(tek_term_name) %>%
count(tek_term_name) %>%
 arrange(desc(n))
total_tek_term_count
#   Everything_for_completed_EIS %>%
#  drop_na(tek_term_name) %>%
# count(tek_term_name) %>%
#  arrange(desc(n))
# total_tek_term_count
```

```{r}
sum(total_tek_term_count$n)
```

# Table export of FEIS Agency
```{r}
write_csv(total_tek_term_count, file="TEK Term Count_FINAL.csv")
```
Results from above: of 708 FEIS; we analyzed 247 FEIS with 961 mentions



#SEPARATE Local Knowledge  and create 2 datasets (1 for LK & TEK) & (indicator variables for a complete TEK set)
--> these will be mentions/repeats, not record_ids, but it could affect record_ids

```{r}
proc_code <- read.csv("Proc_code.csv")

# Define binning function
code_to_bin <- function(code) {
  if (code %in% c(2, 4, 1, 5)) {
    return("Nominal")
  } else if (code %in% c(6, 7, 11)) {
    return("Analysis")
  } else if (code == 9) {
    return("Consultation")
  } else if (code %in% c(13, 12)) {
    return("Mitigation & Monitoring")
  } else if (code == 14) {
    return("Unclear")
  } else {
    return(NA)
  }
}

# Apply binning function
proc_code$proc_bin <- sapply(proc_code$code, code_to_bin)

# Remove rows where proc_bin is "Unclear"
proc_code <- proc_code[proc_code$proc_bin != "Unclear", ]

#we are going to add a column to proc code
#now we join to add the proc name as a column to our data
TEK_proc_quest<- TEK_mentions_ss |> 
  left_join(proc_code, join_by(procedural_use==code)) 
#TEK_proc_quest$procedure_name #code above gives column as vector
#TEK_proc_quest$proc_bin #code above gives column as vector
```



#dataset for LOCAL KNOWLEDGE
TEK : # 1,2, 4-10, 14, 15, 16, 17, 18
LK : #3, 11, 12, 13
```{r}
#LK_sample

LK_sample<- TEK_proc_quest%>%
  filter(tek_term_used %in% c(3, 11, 12, 13)) 
LK_sample
#364 mentions
```

```{r}
#TEK_sample

TEK_sample<-TEK_proc_quest%>%
  filter(tek_term_used %in% c(1, 2, 4:10, 14, 15, 16, 17, 18)) 
TEK_sample
#705 mentions
```

#Create a new variable with combined LK & TEK - creating "indicator variable"
```{r}
TEK_proc_quest <- TEK_proc_quest%>% 
  mutate(tek_term_type = if_else((tek_term_used %in% c(3, 11, 12, 13)), "LK", "TEK"))   #mutate allows to add a column
```


#(bargraph) freq of TEK use
#Now lets try plotting proc_use question
```{r}
TEK_proc_counts<- TEK_proc_quest %>%
  drop_na(procedural_use) %>%
 # group_by(tek_term_type) %>% 
  count(procedure_name, sort = TRUE)

procedural_use_figure.10 <- ggplot(
  TEK_proc_counts, aes(y= reorder(procedure_name,n), x=n))+
  geom_bar(stat= "identity")+
  geom_text(stat= "identity", aes(label=n), hjust=-.3)+
  xlim(0,400) +
  labs(y= "TEK Utilization in FEIS",
       x= "Frequency of Mentions",
       title = "Frequency of Thematic Categories of TEK incorporation")
procedural_use_figure.10
#code above give the procedure type and their sum of counts

# ggsave("TEK_thematic_frequency.jpeg", width = 8, height = 6, dpi = 300)
# procedural_use_figure

```

```{r}
sum(TEK_proc_counts$n)
```

```{r}
#EXPORTING
ggsave("procedural_use_figure.10.tif", dpi = 300)
```


```{r}
LK.TEK_proc_counts<- TEK_proc_quest %>%
  drop_na(procedural_use) %>%
 group_by(tek_term_type) %>% 
  count(procedure_name, sort = TRUE)

procedural_use_figure <- ggplot(
  LK.TEK_proc_counts, aes(y= reorder(procedure_name,n), x=n, fill = tek_term_type))+
  geom_bar(stat= "identity", position="dodge")+ 
  geom_text (stat= "identity", aes(label=n, fill=tek_term_type), position=position_dodge(width=1), hjust=-.3)+
  xlim(0,250) +
  labs(y= "TEK Utilization in FEIS",
       x= "Frequency of Mentions",
       title = "Frequency of Thematic Categories of TEK incorporation")
procedural_use_figure
```

##Trying to fix legend (CHATGBT)
```{r}
LK.TEK_procedural_use_figure <- ggplot(
  LK.TEK_proc_counts,
  aes(y = reorder(procedure_name, n), x = n, fill = tek_term_type)
) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = n, fill = tek_term_type),
    position = position_dodge(width = 1),
    hjust = -0.3
  ) +
  xlim(0, 250) +
  scale_fill_manual(
    name = "Knowledge Type",
    values = c("TEK" = "#008B8B",   # darker turquoise (DarkCyan)
               "LK"  = "#B22222"),  # brick red (FireBrick)
    breaks = c("TEK", "LK"),
    labels = c("Traditional Ecological Knowledge (TEK)",
               "Local Knowledge (LK)")
  ) +
  labs(
    y = "TEK Utilization in FEIS",
    x = "Frequency of Mentions",
    title = "Frequency of TEK Uses per TEK & LK"
  )

LK.TEK_procedural_use_figure
```
```{r}
#EXPORTING
ggsave("LK.TEK_procedural_use_figure.tif", dpi = 300)
```



## From above "TEK_proc_counts" has 10 categories, need to create Proc Bins from 10 categories to 4 groups
```{r}
use_intensity_count <- TEK_proc_quest %>%
  drop_na(procedural_use) %>%
  group_by(proc_bin, tek_term_type) %>% 
#  count(procedure_name, sort = TRUE)
  summarise(n=n()) 
  

Proc_4_bins <- ggplot(
use_intensity_count, aes(y= reorder(proc_bin,n), x=n, fill = tek_term_type))+
  geom_bar(stat= "identity", position="dodge")+ 
  geom_text (stat= "identity", aes(label=n, fill=tek_term_type), 
             position=position_dodge(width=1), hjust=-.3)+
  xlim(0,350) +
  labs(y= "Category Mentions in FEIS",
       x= "Frequency of Mentions",
       title = "Nominal vs. Substantive Mentions in FEIS")
Proc_4_bins
```
##Pretty up the graph above
```{r}
Proc_4_bins_TEK.LK <- ggplot(
  use_intensity_count,
  aes(y = reorder(proc_bin, n), x = n, fill = tek_term_type)
) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = n, fill = tek_term_type),
    position = position_dodge(width = 1),
    hjust = -0.3
  ) +
  xlim(0, 350) +
  scale_fill_manual(
    name = "Knowledge Type",
    values = c("TEK" = "#008B8B",   # darker turquoise
               "LK"  = "#B22222"),  # brick red
    breaks = c("TEK", "LK"),
    labels = c("Traditional Ecological\nKnowledge (TEK)",
               "Local\nKnowledge (LK)")
  ) +
  labs(
    y = "Category Mentions in FEIS",
    x = "Frequency of Mentions",
    title = "Nominal vs. Substantive Mentions in FEIS"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),   # center title
    legend.position = "bottom",                              # move legend below
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 10),
    legend.key.size = unit(0.6, "cm"),
    legend.box = "horizontal"                                # align legend items in a row
  )

Proc_4_bins_TEK.LK

```

```{r}
#EXPORTING
ggsave("Proc_4_bins_TEK.LK.tif", dpi = 300)
```



```{r}
colnames(TEK_proc_quest)
```


#create binary table w/agencies
```{r}
#for each FEIS, keep binary output (yes vs no substantive)
feis_subst<-TEK_proc_quest |>
  select(record_id, binary_subst) |> 
  distinct() #only pull unique row
feis_subst 

#This is per FEIS level

#ok the 'feis_subst' requires a left join of the agency name with the recordID 
feis_subst <- feis_subst |> 
#ORIGINAL --- 
  left_join(Record_ID_completed |> 
#NOPE----  left_join(TEK_mentions_ss |> 
              select(record_id, agency),
            by = join_by (record_id))

#YES! feis_subst has the record, agency, and binary_Subst.vs.Nominal

#count 'type of mentions' for each agency
subst_counts <- feis_subst |> 
  group_by(agency, binary_subst) |> 
  summarise(n=n()) |> 
  pivot_wider(id_cols = agency, #we want one row for e/column of agency
              names_from = binary_subst, #we want the column names from binary column (Y/N)
              values_from = n, #based off 349 'n'
              values_fill = 0) |> 
  arrange(desc(Yes + No))
subst_counts

#ok now we want to export this table into: /Users/kristalina/Documents/TEK Analysis Practice/TEK Analysis Package/ TEK Outputs
#write_csv(x=subst_counts, file = "All Agency Substantive vs. Nominal Mentions.csv")
#you will need to download this CSV and clean up your table and export from CSV
```

```{r}
write.csv(x=subst_counts, file="All Agency Substantive vs. Nominal Mentions.csv", row.names = FALSE)
```



#based on Substantive vs Not  per FEIS Agency, we want to pull top 5 to run Fishers TEST
```{r}
Top_5_Agency <- subst_counts |> 
  ungroup() |> 
  slice_head(n=5)

#now we have the TOP 5!
```

#Fishers Test
```{r}
fisher.test(x=Top_5_Agency[, c("Yes","No")])
```

# Plot Data in Fishers Test
```{r}
#we need to change format to LONG format = pivot_longer
#TOP 5 LONG
Long_top_5 <- Top_5_Agency |> 
  pivot_longer(cols= -agency, #this (-) means leave agency column as is
               names_to = "binary_subst", #taking Y?N column names and turning them into column, with column called 'binary_subst'
               values_to = "n") #create a column called n

plotting_fishers <- ggplot(
Long_top_5 , aes(
  y= reorder(agency, n), x= n, fill = binary_subst))+
  geom_bar(stat= "identity", position="dodge")+ 
  geom_text (stat= "identity", aes(label=n, fill=binary_subst), 
             position = position_dodge(width=1), hjust=-.3) +
  xlim(0,65) +
  labs(y= "Agencies",
       x= "FEIS count",
       title = "Nominal vs. Substantive FEIS")
plotting_fishers
```
#pretty up code above (Chatgbt)
```{r}
library(ggplot2)
library(stringr)

Nom.Sub_top5agencies <- ggplot(
  Long_top_5,
  aes(y = reorder(agency, n), x = n, fill = binary_subst)
) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = n, fill = binary_subst),
    position = position_dodge(width = 1),
    hjust = -0.3
  ) +
  xlim(0, 65) +
  scale_fill_manual(
    name = "Substantive Mention",
    values = c("Yes" = "#008B8B",  # darker turquoise
               "No"  = "#B22222"), # brick red
    breaks = c("Yes", "No"),
    labels = c("Substantive\n(Yes)", "Nominal\n(No)")
  ) +
  labs(
    y = "Agencies",
    x = "FEIS Count",
    title = "Nominal vs. Substantive FEIS"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # center title
    axis.text.y = element_text(size = 11, lineheight = 0.9), # larger & better spaced y labels
    legend.position = "bottom",                             # move legend below
    legend.justification = "center",                        # center legend
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 10),
    legend.key.size = unit(0.6, "cm"),
    legend.box = "horizontal",                              # horizontal layout
    plot.margin = margin(10, 10, 20, 10)                    # add space for legend
  ) +
  scale_y_discrete(labels = function(x) str_wrap(x, width = 25))  # wrap long agency names

Nom.Sub_top5agencies


```
```{r}
ggsave("Nom.Sub_top5agencies.tif", dpi = 300)
```


#create SUBJECT MATTER thematic bins: 
#CSV file name:subject_tek_use_code
#Column name:(code = 51-80 ; subject_tek_use = Archaeology)

```{r}
subject_use_wide<- TEK_proc_quest %>% 
  select(record_id, register_date, tek_term_type, starts_with("subject_tek_use___"))
subject_use_wide #use this to create long format of data

#pivot wide subject use columns to long format
record_subject <- subject_use_wide %>% 
  pivot_longer( #turned subject columns from wide to long
    !c(record_id, register_date, tek_term_type), 
    names_to = "tek_subject_matter",
    names_prefix = "subject_tek_use___",
    values_to = "present",
    names_transform = list(tek_subject_matter = as.integer)
  ) %>% 
  filter (present ==1) %>% #only keep rows where the subject was present for record present ==1)
  filter(!tek_subject_matter %in% c(85, 555)) %>%  # remove unwanted codes
 # distinct() %>%  #remove duplicates<- OMG THIS WAS THE ERROR
  select(!present) # remove present column (not information)
record_subject
```

```{r}
library(tidyverse)

TEK_subject_quest_subjects <- record_subject %>%
  left_join(
    read_csv("subject_tek_use_code.csv"), join_by(tek_subject_matter == code)) %>%
  drop_na(subject_tek_use) %>%
  count(subject_tek_use, sort = TRUE)

```
```{r}
sum(TEK_subject_quest_subjects$n)
#total count of subject mentions = 1154
```


```{r}
ggplot(TEK_subject_quest_subjects, aes(y= reorder(subject_tek_use,n), x=n))+
  geom_bar(stat= "identity", fill = "#008B8B") +
  geom_text(stat= "identity", aes(label=n), hjust=-.05) +
  labs(y= "Subject Themes",
       x= "Frequency of Subject Mentions",
       title = "Frequency of TEK Subject Themes in FEIS")

```

```{r}
library(ggplot2)

total_subject_categories_barplot<- ggplot(TEK_subject_quest_subjects, aes(
  y = reorder(subject_tek_use, n),
  x = n
)) +
  geom_bar(stat = "identity", fill = "#008B8B") +  # use color for contrast
  geom_text(
    aes(label = n),
    hjust = -0.3,          # move labels further out for clarity
    size = 3,            # adjust text size
    color = "black"
  ) +
  labs(
    y = "Subject Themes",
    x = "Frequency of Subject Mentions",
    title = "Frequency of TEK Subject Themes in FEIS"
  ) +
  theme_minimal(base_size = 10) +  # cleaner base font size
  theme(
    axis.text.y = element_text(size = 8, hjust = 1, lineheight = 1.3),  # larger y labels
    axis.text.x = element_text(size = 10),
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    panel.grid.major.y = element_blank(),  # remove horizontal lines
    panel.grid.minor = element_blank(),
    plot.margin = margin(10, 40, 10, 10)   # adds space for the numbers
  ) +
  coord_cartesian(clip = "off")  # prevents numbers from being cut off
total_subject_categories_barplot
```
```{r}
ggsave("total_subject_categories_barplot.tif", dpi = 300)
```




##TEK Frequency of 36 Subject Themes, per LK & TEK (Figure 5)
```{r}
#I will need to add the LK & TEK
#make 36 subjects into 16 categories
#plot 16 themes into LK & TEK

subject_lookup<-read_csv("subject_tek_use_code.csv")

record_subject_connect <- record_subject %>%
  left_join(subject_lookup, by = c("tek_subject_matter" = "code")) |> 
  left_join(Record_ID_completed, by = join_by(record_id))
record_subject_connect
#we now connected the subject & Agency information needed to run this

```



# Subject into 16 categories
```{r}
subj_bin_counts <- record_subject_connect %>%
  group_by(subj_group, tek_term_type) %>%
  summarise(count = n(), .groups = "drop")


ggplot(subj_bin_counts, aes(
  x = count,
  y = reorder(subj_group, count),
  fill = tek_term_type
)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(
    aes(label = count),
    position = position_dodge(width = 0.9),
    hjust = -0.1,
    size = 3
  ) +
  labs(
    x = "Frequency of Mentions",
    y = "Subject Themes",
    fill = "Knowledge Type",
    title = "Frequency of TEK and LK Subject Mentions in FEISs"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 10, lineheight = 1.4),
    legend.position = "bottom",
    plot.title = element_text(face = "bold", hjust = 0.5)
  ) #+
 # xlim(0, max(subject_counts$count) * 1.15)

```


##Frequency of subject themes for all agencies (appendix)
```{r}
agencies_subject_quest <- record_subject_connect |> 
  group_by(agency, subj_group, tek_term_type) |> 
  summarise(count = n(), .groups = "drop")

agencies_subject_quest <- agencies_subject_quest |> 
  mutate (subj_group = gsub(pattern = "&",
  replacement = "and", x=subj_group))
  # sub('Fish & Wildlife', 
  #    'Fish and Wildlife') 
```

#graph it
```{r}
#set color scale
cols <- c("Sites" = "#8c564b", 
"Traditional Ways of Life" = "#ff7f0e",
"Subsistence resources" = "#da6600",
"Fish and Wildlife" = "#7f7f7f",
"Plants" = "#2ca02c",
"Habitat" = "#9467bd",
"Biophysical Characteristics" = "#7b49a8", 
"Water" = "#1f77b4", 
"Air Quality" = "#17becf",
"Soil Quality" = "#1294a1",
"Fire" = "#d62728", 
"Climate"= "#bcbd22",
"Navigation"= "#e377c2", 
"Economics" = "#da4daf", 
"Human Health"= "#ffaa0e",
"Environmental Justice" = "#da8d00")

color_group_order<- c("Sites", 
"Traditional Ways of Life",
"Subsistence resources",
"Fish and Wildlife",
"Plants",
"Habitat",
"Biophysical Characteristics", 
"Water", 
"Air Quality",
"Soil Quality",
"Fire", 
"Climate",
"Navigation", 
"Economics", 
"Human Health",
"Environmental Justice")

# ggplot(agencies_subject_quest, aes (x=tek_term_type, y=count, fill= subj_group)  ) +
#   geom_bar(stat="identity",position="dodge") +
#   scale_fill_manual(values = cols)
```

```{r}
#make separate plot for each agency
for (agency_name in unique (agencies_subject_quest$agency)) {
 agency_subject_plot<- ggplot(agencies_subject_quest |> filter(agency == agency_name), 
         aes (x=tek_term_type, y=count, fill= subj_group)  ) +
    geom_bar(stat="identity",position="dodge") +
   geom_text(aes(label = count),
              position = position_dodge(width = 0.9),
              vjust = -0.5, size = 3) +
    labs(y = "Frequency",
#         x = "TEK vs LK",
         title = paste0(agency_name, " usage per Subject Group"),
         fill = "Subject group") +
    scale_fill_manual(values = cols) +
       theme_minimal() +
    theme(legend.position = "bottom", 
          axis.title.x = element_blank())
   #       axis.text.x = element_text(angle = 45, hjust = 1))
 print(agency_subject_plot)
}

```

# re-run code above to modify spacing (Chatgbt help formatting)
```{r}
library(ggplot2)
library(grid)

# Define your custom color mapping and order (from your screenshot)
cols <- c(
  "Sites" = "#8c564b",
  "Traditional Ways of Life" = "#ff7f0e",
  "Subsistence resources" = "#da6000",
  "Fish and Wildlife" = "#7f7f7f",
  "Plants" = "#2ca02c",
  "Habitat" = "#9467bd",
  "Biophysical Characteristics" = "#7b49a8",
  "Water" = "#1f77b4",
  "Air Quality" = "#17becf",
  "Soil Quality" = "#1294a1",
  "Fire" = "#d62728",
  "Climate" = "#bcbd22",
  "Navigation" = "#e377c2",
  "Economics" = "#da4daf",
  "Human Health" = "#ffaa0e",
  "Environmental Justice" = "#da8d00"
)

color_group_order <- c(
  "Sites", "Traditional Ways of Life", "Subsistence resources",
  "Fish and Wildlife", "Plants", "Habitat", "Biophysical Characteristics",
  "Water", "Air Quality", "Soil Quality", "Fire", "Climate",
  "Navigation", "Economics", "Human Health", "Environmental Justice"
)

# Loop through each agency and create plot
for (agency_name in unique(agencies_subject_quest$agency)) {
  
  agency_data <- agencies_subject_quest |> filter(agency == agency_name)
  ymax <- max(agency_data$count) * 1.25
  
  # Make subj_group follow your preferred order
  agency_data$subj_group <- factor(agency_data$subj_group, levels = color_group_order)
  
  agency_subject_plotS <- ggplot(
    agency_data,
    aes(x = tek_term_type, y = count, fill = subj_group)
  ) +
    geom_bar(stat = "identity", position = "dodge") +
    geom_text(
      aes(label = count),
      position = position_dodge(width = 0.9),
      vjust = -0.3, size = 3
    ) +
    labs(
      y = "Frequency",
      title = paste0(agency_name, " usage per Subject Group"),
      fill = "Subject Group"
    ) +
    scale_y_continuous(
      breaks = scales::pretty_breaks(),
      labels = function(x) floor(x)
    ) +
    scale_fill_manual(
      values = cols,
      breaks = color_group_order  # Ensures legend matches your defined order
    ) +
    coord_cartesian(ylim = c(0, ymax), clip = "off") +
    theme_minimal(base_size = 12) +
    guides(fill = guide_legend(nrow = 3, byrow = TRUE)) +
    theme(
      legend.position = "bottom",
      legend.text = element_text(size = 8),
      legend.title = element_text(size = 9, face = "bold"),
      legend.key.size = unit(0.4, "cm"),
      legend.spacing.x = unit(0.15, "cm"),
      legend.spacing.y = unit(0.15, "cm"),
      legend.box.spacing = unit(0.3, "cm"),
      legend.box = "horizontal",
      plot.margin = margin(10, 20, 70, 10),  # more space for 3-row legend
      axis.title.x = element_blank(),
      plot.title = element_text(hjust = 0.5, face = "bold")
    )
  
  ggsave(plot = agency_subject_plotS, 
         filename = paste0("subject-type-", agency_name,".png"))
  print(agency_subject_plotS)
}
```



##Frequency of subject themes per top 6 agencies (Figure 6)

```{r}
Top_6_FEIS_agency <- agencies_subject_quest  %>% 
  filter(agency %in% c("Forest Service", 
                       "U.S. Army Corps of Engineers", 
                       "Bureau of Land Management", 
                       "Minerals Management Service", 
                       "National Oceanic and Atmospheric Administration", 
                       "Federal Highway Administration")) %>% 
  mutate(agency= factor(agency,levels=c("Forest Service", 
                       "U.S. Army Corps of Engineers", 
                       "Bureau of Land Management", 
                       "Minerals Management Service", 
                       "National Oceanic and Atmospheric Administration", 
                       "Federal Highway Administration"),
                       ordered=TRUE))

#now plot it!
ggplot(Top_6_FEIS_agency, aes(x = tek_term_type, y = count, fill = subj_group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  geom_text(aes(label = count), 
            position = position_dodge(width = 0.9), 
            vjust = -0.5, size = 1.8) +
  facet_wrap(~agency) +
  labs(y = "Frequency of Subject mentions",
       x = NULL, #"TEK vs LK",
       title = "Top Agency Usage per Subject Group",
       fill = "Subject Themes") +
  scale_fill_manual(values = cols) +
   scale_y_continuous(expand = expansion(c(0, 0.2))) +
  theme(strip.text.x = element_text(size = 5),
        axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position="bottom",
        legend.text = element_text(size=8),
        legend.title=element_text(size=8)) +
  guides(fill = guide_legend(override.aes = list(size = 0.5)))

```



GOT STUCK HERE

##Top 5 TEK terms from years 2000-2022
#Plot frequency of use over time (*time) with terms used
Sample size 249, plot freq, by term, over time
```{r}
#joining the term and interaction of time
Term_over_time <- left_join(Everything_for_completed_EIS, tek_term, join_by(tek_term_used==code)) 
Term_over_time <- Term_over_time %>% 
  #date, tek term name
select(record_id, register_date,tek_term_name) %>% 
  fill(register_date) %>% 
  mutate(register_date = as.Date(x=register_date, tryFormats = "%m/%d/%y")) %>% 
  mutate(year = year(register_date)) %>% #create column with just the year
  drop_na(year, tek_term_name) %>%  #remove NAs
  count(year, tek_term_name) %>% #count each term for each year
  group_by(year) %>% 
  mutate(prop=n/sum(n))
Term_over_time
```
```{r}
ggplot(Term_over_time, aes(x = year, y = n, color = tek_term_name)) +
  geom_point (stat="identity") + #stat = identity, we have calculated counts already, plot it
  geom_line () +
  
labs(title = "Frequency of TEK Terms Over Time",
     x = "Year",
     y = "Frequency",
     color = "TEK Term") +
  theme_minimal()


# agency_subset %>% 
#   filter(tek_term_type=="LK") %>% 
#   ggplot(aes(x=year, y=n, color=subj_group))+
#   geom_point(stat="identity") +
#   geom_line()
```



```{r}
#THIS IS WHERE YOU LEFT OFF if you want to change the colors for graph above
#we want those labeled as LK near the same color: 3: Traditional Local Knowledge, 11. Local Knowledge, 12. Local Ecological Knowledge, 13. Local Community Knowledge


#now lets change the color palette
# cols <- c(
#   "Sites" = "#8c564b",
#   "Traditional Ways of Life" = "#ff7f0e",
#   "Subsistence resources" = "#da6000",
#   "Fish and Wildlife" = "#7f7f7f",
#   "Plants" = "#2ca02c",
#   "Habitat" = "#9467bd",
#   "Biophysical Characteristics" = "#7b49a8",
#   "Water" = "#1f77b4",
#   "Air Quality" = "#17becf",
#   "Soil Quality" = "#1294a1",
#   "Fire" = "#d62728",
#   "Climate" = "#bcbd22",
#   "Navigation" = "#e377c2",
#   "Economics" = "#da4daf",
#   "Human Health" = "#ffaa0e",
#   "Environmental Justice" = "#da8d00"
# )
```

#

